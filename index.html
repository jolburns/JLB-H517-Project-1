<!DOCTYPE html>
<html>
<head>
	<title>Project 1 - John L Burns - Cholera Map</title>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<style>
    	text { 
			font-family: Arial; 
			font-size: 15px;
		}
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.tick text {
			fill: black;
			font-size: 11px;
		}

		rect {
			stroke: white;
		}
	</style>
</head>
<body>

	<svg id="map" width="600" height="600">
		<text id='label' x='0' y='20'>1854 Broad Street Cholera Outbreak</text>
		<g transform="translate(30,40)"></g>
	</svg></br>
	<svg id="death_day_bar" width="300" height="200">
		<text id='label' x='0' y='20'>Deaths by day</text>
		<g transform="translate(30,40)"></g>
	</svg>
	<div id="tooltip" death_bars='null'></div>
	<svg id="age_bar" width="300" height="200">
		<text id='label' x='0' y='20'>Deaths by age group</text>
		<g transform="translate(30,40)"></g>
	</svg>
	<svg id="sex_bar" width="300" height="200">
		<text id='label' x='0' y='20'>Deaths by sex</text>
		<g transform="translate(30,40)"></g>
	</svg>
	
	
	<script>
		//setting up variables for later
		//main map
		var map_width = 600;
		var map_height = 600;
		
		//death date bars
		var ddb_width = 500;
		var ddb_height = 200;
		var ddb_bar_height_max = 140;
		var ddb_bar_height_offset = 30;
		var ddb_bar_width = 10;
		
		//age group bars
		var ab_width = 0;
		var ab_x_offset = 25;
		var ab_height = 200;
		var ab_bar_height_offset = 30;
		var ab_bar_height_max = 140;
		var ab_bar_width = 0;
		
		//sex group bars
		var sb_width = 0;
		var sb_x_offset = 25;
		var sb_height = 260;
		var sb_bar_height_offset = 30;
		var sb_bar_height_max = 200;
		var sb_bar_width = 0;
		
		//arrays
		var street_start_stop = [];
		var pumps = [];
		var death_days = [];
		var days = [];
		var max_death_day = [0];
		var death_xy_age_sex_date = [];
		
		//select the svgs
		var map_svg = d3.select("#map").attr("width", map_width).attr("height", map_height);
		var death_day_bar_svg = d3.select("#death_day_bar");
		var age_bar_svg = d3.select("#age_bar")
		var sex_bar_svg = d3.select("#sex_bar");
			
		//select the tooltip
		var tooltip = d3.select("#tooltip");
		
		//loading in streets.json and displaying the map
		d3.json('streets.json', function(data) 
		{
			// Loop through all objects
			for (i = 0; i < data.length; i++) 
			{
				for (j = 0; j < data[i].length - 1; j++)
				{
					x1 = parseFloat(data[i][j]['x'])
					y1 = parseFloat(data[i][j]['y'])
					x2 = parseFloat(data[i][j+1]['x'])
					y2 = parseFloat(data[i][j+1]['y'])
					street_start_stop.push([x1+0.06, y1+0.08, x2+0.06, y2+0.08]);
					//street_start_stop.push([x1-0.06, y1-0.08, x2-0.06, y2-0.08]);
				}
			}
			
			//make the empty lines
			var map_lines = map_svg.selectAll('line').data(street_start_stop).enter().append('line');
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(street_start_stop, function(sss) {return sss[0];})]).range([-50, map_width-100]);
			var y_scale = d3.scale.linear().domain([0, d3.max(street_start_stop, function(sss) {return sss[1];})]).range([map_height-50, 50]);
			
			//set x1/y1 for the lines
			map_lines.attr('x1', function(sss) {return x_scale(sss[0])}).attr('y1', function(sss) {return y_scale(sss[1])});
			//set x2/y2 for the lines
			map_lines.attr('x2', function(sss) {return x_scale(sss[2])}).attr('y2', function(sss) {return y_scale(sss[3])});
			
			//color in the lines
			map_lines.attr('stroke', "black");
		});
		
		
		//loading in pumps.csv and displaying them
		d3.csv("pumps.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				pumps.push([i, data[i]['x'], data[i]['y']]);
			}
			//console.log(pumps);
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[1];})]).range([-45, map_width-400]);
			var y_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[2];})]).range([map_height-53, 290]);
			
			//make the empty pump icons
			var pump_icons = map_svg.selectAll("circle").data(pumps).enter().append("circle");
			
			//set x/y for pumps
			pump_icons.attr("cx", function(p) {return x_scale(p[1]);}).attr("cy", function(p) {return y_scale(p[2]);}).attr("r", 4);
			
			//color the icons
			pump_icons.attr("fill", "blue");
		});
		
		//loading in deathdays.csv 
		d3.csv("deathdays.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				death_days.push([i, data[i]['date'], data[i]['deaths']]);
				days.push(data[i]['date']);
				if(data[i]['deaths'] >= max_death_day[0]) {max_death_day[0] = parseInt(data[i]['deaths']);}
			}
			//console.log(death_days);
		});
		
		//loading in deaths_age_sex.csv and displaying them
		d3.csv("deaths_age_sex.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				//convert gender
				if(data[i]['gender'] == 0){g = 'Male';}
				else{g = 'Female';}
				
				//convert age
				switch (data[i]['age'])
				{
					case '0': age = '0-10'; break;
					case '1': age = '11-20'; break;
					case '2': age = '21-40'; break;
					case '3': age = '41-60'; break;
					case '4': age = '61-80'; break;
					case '5': age = '> 81'; break;
				}
				death_xy_age_sex_date.push([data[i]['x'], data[i]['y'], age, g, 0]);
			}
			
			//assigning the id of the day died to each person
			count = 0;
			for(i = 0; i < death_days.length; i++)
			{
				for(j = 0; j < death_days[i][2]; j++)
				{
					death_xy_age_sex_date[count][4] = death_days[i][0];
					death_xy_age_sex_date[count][5] = death_days[i][1];
					count = count+1;
				}
			}
			//console.log(death_xy_age_sex_date);
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[1];})]).range([-45, map_width-400]);
			var y_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[2];})]).range([map_height-52, 290]);
			
			//make the empty death icons
			var death_icons = map_svg.selectAll('rect').data(death_xy_age_sex_date).enter().append('rect');
			
			//set x/y/date for deaths
			death_icons.attr("x", function(p) {return x_scale(p[0]);})
				.attr("y", function(p) {return y_scale(p[1]);})
				.attr("date", function(p) {return p[5];});
			
			//color and size
			death_icons.attr("width", 5).attr("height", 3).attr("fill", "red");
			
			
			//make the deaths by day bar chart
			//correct ddb_width
			ddb_width = 10*days.length;
			ddb_x_offset = 25;
			death_day_bar_svg.attr("width", ddb_width+ddb_x_offset).attr("height", ddb_height);
			
			//add axis - help from https://stackoverflow.com/questions/41579560/custom-x-axis-labels-in-d3-bar-charts
			//additional help from https://stackoverflow.com/questions/52026579/how-to-draw-grid-lines-fir-every-ticks
			var ddx = d3.scale.ordinal().domain(days).rangeRoundBands([-12, ddb_width], .005);
			var ddx_axis = d3.svg.axis().scale(ddx).orient("bottom").tickSize(0);
			death_day_bar_svg.append("g").attr("class", "x axis")
				.attr("transform", "translate("+ddb_x_offset+","+(ddb_height-ddb_bar_height_offset)+")").call(ddx_axis)
				.selectAll("text").attr("transform", "rotate(-90)").style("font-size", "7px").style("text-anchor", "end");
			
			var ddy = d3.scale.linear().domain([max_death_day,0]).range([0,ddb_height-2*ddb_bar_height_offset]);
			var ddy_axis = d3.svg.axis().scale(ddy).orient("left").ticks(6).outerTickSize(0).innerTickSize(-ddb_width);
			death_day_bar_svg.append("g").attr("class", "y axis").attr("transform", "translate("+(ddb_x_offset-3)+","+(ddb_bar_height_offset)+")")
				.call(ddy_axis).style("stroke-dasharray", "5 5")
				.selectAll("text").attr("transform", "rotate(0)").style("font-size", "7px").style("text-anchor", "end");
			//console.log(death_days)
			//create the blank rectangles, then give them properties
			var death_bars = death_day_bar_svg.selectAll('rect').data(death_days).enter().append('rect');
			death_bars.attr('height', function(dd) {return 1+ (dd[2]/max_death_day)*ddb_bar_height_max;})
				.attr('width', ddb_bar_width).attr('x', function(dd, i) {return i*ddb_bar_width;})
				.attr('y', function(dd) {return ddb_height - ddb_bar_height_offset - 2 - (dd[2]/max_death_day)*ddb_bar_height_max})
				.attr("date", function(dd) {return dd[1];})
				.attr("fill", "red").attr("transform","translate("+ddb_x_offset+",0)");
			
			
			//make the age bars
			//console.log(death_xy_age_sex_date);
			//array of arrays holding the actual age data
			var age_deaths = [['0-10', 0], ['11-20', 0], ['21-40', 0], ['41-60', 0], ['61-80', 0], ['> 81', 0]];
			var ages = [];
			var max_death_age = 0;
			for(i =0; i < age_deaths.length; i++)
			{
				count = death_xy_age_sex_date.filter(function(d) {
					return d[2] == age_deaths[i][0];
				}).length;
				age_deaths[i][1] = count;
				ages.push(age_deaths[i][0]);
				if(count > max_death_age){max_death_age = count;}
			}
			//console.log(age_deaths);
			
			//Fix width now that we have data
			ab_width = 25*age_deaths.length;
			ab_bar_width = ab_width/age_deaths.length;
			
			//set the chart svg width/height
			age_bar_svg.attr("width", ab_width+ab_x_offset).attr("height", ab_height);
			
			var agex = d3.scale.ordinal().domain(ages).rangeRoundBands([-12, ab_width], .005);
			var agex_axis = d3.svg.axis().scale(agex).orient("bottom").tickSize(0);
			age_bar_svg.append("g").attr("class", "x axis")
				.attr("transform", "translate("+ab_x_offset+","+(ab_height-ab_bar_height_offset)+")").call(agex_axis)
				.selectAll("text").attr("transform", "rotate(-90)").style("font-size", "7px").style("text-anchor", "end");
			
			var agey = d3.scale.linear().domain([max_death_age,0]).range([0,ab_height-2*ab_bar_height_offset]);
			var agey_axis = d3.svg.axis().scale(agey).orient("left").ticks(6).outerTickSize(0).innerTickSize(-ab_width);
			
			age_bar_svg.append("g").attr("class", "y axis").attr("transform", "translate("+(ab_x_offset-3)+","+(ab_bar_height_offset)+")")
				.call(agey_axis).style("stroke-dasharray", "5 5")
				.selectAll("text").attr("transform", "rotate(0)").style("font-size", "7px").style("text-anchor", "end");
			//create the blank rectangles, then give them properties
			var age_bars = age_bar_svg.selectAll('rect').data(age_deaths).enter().append('rect');
			
			age_bars.attr('height', function(dd) {return 1+ (dd[1]/max_death_age)*ab_bar_height_max;})
				.attr('width', ab_bar_width).attr('x', function(dd, i) {return i*ab_bar_width;})
				.attr('y', function(dd) {return ab_height - ab_bar_height_offset - 2 - (dd[1]/max_death_age)*ab_bar_height_max})
				.attr("age", function(dd) {return dd[0];})
				.attr("fill", "red").attr("transform","translate("+ab_x_offset+",0)");
			
			
			//make the sex bars
			//console.log(death_xy_age_sex_date);
			//array of arrays holding the actual age data
			var sexes = ['Male','Female'];
			var sex_deaths = [['Male',0],['Female',0]];
			var max_death_sex = 0;
			for(i =0; i < sexes.length; i++)
			{
				count = death_xy_age_sex_date.filter(function(d) {
					return d[3] == sexes[i];
				}).length;
				sex_deaths[i][1] = count;
				if(count > max_death_sex){max_death_sex = count;}
			}
			//console.log(sex_deaths);
			
			
			
			//Fix width now that we have data
			sb_width = 45*sex_deaths.length;
			sb_bar_width = sb_width/sex_deaths.length;
			
			//set the chart svg height/width
			sex_bar_svg.attr("width", sb_width+sb_x_offset).attr("height", sb_height);
			
			var sexx = d3.scale.ordinal().domain(sexes).rangeRoundBands([-12, sb_width], .005);
			var sexx_axis = d3.svg.axis().scale(sexx).orient("bottom").tickSize(0);
			sex_bar_svg.append("g").attr("class", "x axis")
				.attr("transform", "translate("+sb_x_offset+","+(sb_height-sb_bar_height_offset)+")").call(sexx_axis)
				.selectAll("text").attr("transform", "rotate(-90)").style("font-size", "7px").style("text-anchor", "end");
			
			var sexy = d3.scale.linear().domain([max_death_sex,0]).range([0,sb_height-2*sb_bar_height_offset]);
			var sexy_axis = d3.svg.axis().scale(sexy).orient("left").ticks(6).outerTickSize(0).innerTickSize(-sb_width);
			
			sex_bar_svg.append("g").attr("class", "y axis").attr("transform", "translate("+(sb_x_offset-3)+","+(sb_bar_height_offset)+")")
				.call(sexy_axis).style("stroke-dasharray", "5 5")
				.selectAll("text").attr("transform", "rotate(0)").style("font-size", "7px").style("text-anchor", "end");
			//create the blank rectangles, then give them properties
			var sex_bars = sex_bar_svg.selectAll('rect').data(sex_deaths).enter().append('rect');
			
			sex_bars.attr('height', function(dd) {return 1+ (dd[1]/max_death_sex)*sb_bar_height_max;})
				.attr('width', sb_bar_width).attr('x', function(dd, i) {return i*sb_bar_width;})
				.attr('y', function(dd) {return sb_height - sb_bar_height_offset - 2 - (dd[1]/max_death_sex)*sb_bar_height_max})
				.attr("age", function(dd) {return dd[0];})
				.attr("fill", "red").attr("transform","translate("+sb_x_offset+",0)");
			
			
			//give the death bars mouse click events
			//some help from https://stackoverflow.com/questions/35222285/d3-js-bar-mouseover
			//and https://stackoverflow.com/questions/58701387/d3-js-select-node-element-based-on-attributes-value-using-selectall
			death_bars.on("click", function(d) {
				//get the current state of the chart
				selected_state = death_bars.filter(function() {
					return d3.select(this).attr("date") == d[1];
				}).attr("fill") == 'red';
				unselected_state = death_bars.filter(function() {
					return d3.select(this).attr("date") != d[1];
				}).attr("fill") == 'red';
				
				//if the user clicked the same bar, then reset
				if(selected_state == true && unselected_state == false){
					//reset the tooltip
					tooltip.text("");
					tooltip.attr("death_bars", 'null');
					death_bars.filter(function() {
						return d3.select(this).attr("date") != d[1];
					}).attr("fill", 'red');
					death_icons.filter(function() {
						return d3.select(this).attr("date") != d[1];
					}).attr("fill", 'red');
				} else {
					//change the tooltip under the bar chart
					tooltip.text(d[1] + " deaths: " + d[2]);
					tooltip.attr("death_bars", d[1]);
					death_bars.filter(function() {
						return d3.select(this).attr("date") != d[1];
					}).attr("fill", 'black');
					death_icons.filter(function() {
						return d3.select(this).attr("date") != d[1];
					}).attr("fill", 'black');
					death_bars.filter(function() {
						return d3.select(this).attr("date") == d[1];
					}).attr("fill", 'red');
					death_icons.filter(function() {
						return d3.select(this).attr("date") == d[1];
					}).attr("fill", 'red');
				}
			})
			/*.on("mouseout", function(d) {
				
			})*/;
		});
		
		
		
	</script>
</body>


</html>
