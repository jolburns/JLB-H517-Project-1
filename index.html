<!DOCTYPE html>
<html>
<head>
	<title>Project 1 - John L Burns - Cholera Map</title>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<style>
    	text { 
			font-family: Arial; 
			font-size: 15px;
		}
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}
		.tick text {
			fill: black;
			font-size: 11px;
		}

		rect {
			stroke: white;
		}
	</style>
</head>
<body>

	<svg id="map" width="600" height="600">
		<text id='label' x='0' y='20'>1854 Broad Street Cholera Outbreak</text>
		<g transform="translate(30,40)"></g>
	</svg></br>
	<svg id="death_day_bar" width="300" height="200">
		<text id='label' x='0' y='20'>Deaths by day</text>
		<g transform="translate(30,40)"></g>
	</svg>
	
	<script>
		//setting up variables for later
		var map_width = 600;
		var map_height = 600;
		var ddb_width = 300;
		var ddb_height = 200;
		var ddb_bar_height_max = 180;
		var ddb_bar_width = 10;
		var street_start_stop = [];
		var pumps = [];
		var death_days = [];
		var max_death_day = [0];
		var death_xy_age_sex_date = [];
		
		//select the svgs
		var map_svg = d3.select("#map").attr("width", map_width).attr("height", map_height);
		var death_day_bar_svg = d3.select("#death_day_bar").attr("width", ddb_width).attr("height", ddb_height);;
		
		//loading in streets.json and displaying the map
		d3.json('streets.json', function(data) 
		{
			// Loop through all objects
			for (i = 0; i < data.length; i++) 
			{
				for (j = 0; j < data[i].length - 1; j++)
				{
					x1 = parseFloat(data[i][j]['x'])
					y1 = parseFloat(data[i][j]['y'])
					x2 = parseFloat(data[i][j+1]['x'])
					y2 = parseFloat(data[i][j+1]['y'])
					street_start_stop.push([x1+0.06, y1+0.08, x2+0.06, y2+0.08]);
					//street_start_stop.push([x1-0.06, y1-0.08, x2-0.06, y2-0.08]);
				}
			}
			
			//make the empty lines
			var map_lines = map_svg.selectAll('line').data(street_start_stop).enter().append('line');
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(street_start_stop, function(sss) {return sss[0];})]).range([-50, map_width-100]);
			var y_scale = d3.scale.linear().domain([0, d3.max(street_start_stop, function(sss) {return sss[1];})]).range([map_height-50, 50]);
			
			//set x1/y1 for the lines
			map_lines.attr('x1', function(sss) {return x_scale(sss[0])}).attr('y1', function(sss) {return y_scale(sss[1])});
			//set x2/y2 for the lines
			map_lines.attr('x2', function(sss) {return x_scale(sss[2])}).attr('y2', function(sss) {return y_scale(sss[3])});
			
			//color in the lines
			map_lines.attr('stroke', "black");
		});
		
		
		//loading in pumps.csv and displaying them
		d3.csv("pumps.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				pumps.push([i, data[i]['x'], data[i]['y']]);
			}
			//console.log(pumps);
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[1];})]).range([-45, map_width-400]);
			var y_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[2];})]).range([map_height-53, 290]);
			
			//make the empty pump icons
			var pump_icons = map_svg.selectAll("circle").data(pumps).enter().append("circle");
			
			//set x/y for pumps
			pump_icons.attr("cx", function(p) {return x_scale(p[1]);}).attr("cy", function(p) {return y_scale(p[2]);}).attr("r", 4);
			
			//color the icons
			pump_icons.attr("fill", "blue");
		});
		
		//loading in deathdays.csv 
		d3.csv("deathdays.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				death_days.push([i, data[i]['date'], data[i]['deaths']]);
				if(data[i]['deaths'] >= max_death_day[0]) {max_death_day[0] = parseInt(data[i]['deaths']);}
			}
			//console.log(death_days);
		});
		
		//loading in deaths_age_sex.csv and displaying them
		d3.csv("deaths_age_sex.csv", function(data)
		{
			for(i = 0; i < data.length; i++)
			{
				//convert gender
				if(data[i]['gender'] == 0){g = 'Male';}
				else{g = 'Female';}
				
				//convert age
				switch (data[i]['age'])
				{
					case '0': age = '0-10'; break;
					case '1': age = '11-20'; break;
					case '2': age = '21-40'; break;
					case '3': age = '41-60'; break;
					case '4': age = '61-80'; break;
					case '5': age = '> 81'; break;
				}
				death_xy_age_sex_date.push([data[i]['x'], data[i]['y'], age, g, 0]);
			}
			
			//assigning the id of the day died to each person
			count = 0;
			for(i = 0; i < death_days.length; i++)
			{
				for(j = 0; j < death_days[i][2]; j++)
				{
					death_xy_age_sex_date[count][4] = death_days[i][0];
					count = count+1;
				}
			}
			//console.log(death_xy_age_sex_date);
			
			//functions to fix scaling
			var x_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[1];})]).range([-45, map_width-400]);
			var y_scale = d3.scale.linear().domain([0, d3.max(pumps, function(p) {return p[2];})]).range([map_height-52, 290]);
			
			//make the empty death icons
			var death_icons = map_svg.selectAll('rect').data(death_xy_age_sex_date).enter().append('rect');
			
			//set x/y for deaths
			death_icons.attr("x", function(p) {return x_scale(p[0]);}).attr("y", function(p) {return y_scale(p[1]);});
			
			//color and size
			death_icons.attr("width", 5).attr("height", 3).attr("fill", "red");
			
			//make the deaths by day bar chart
			//create the blank rectangles, then give them properties
			var death_bars = death_day_bar_svg.selectAll('rect').data(death_days).enter().append('rect');
			death_bars.attr('height', function(dd) {return (dd[2]/max_death_day)*ddb_bar_height_max;})
				.attr('width', ddb_bar_width).attr('x', function(dd, i) {return i*ddb_bar_width;})
				.attr('y', function(dd) {return ddb_height - (dd[2]/max_death_day)*ddb_bar_height_max})
				.attr("fill", "red");
		});
		
		
		
	</script>
</body>


</html>
